rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isDoctor() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'doctor';
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Doctors collection - PUBLIC READ for search functionality
    match /doctors/{doctorId} {
      allow read: if true; // Public read for doctor search
      allow create: if isAdmin();
      allow update: if isOwner(doctorId) || isAdmin(); // Doctors can update their own profile
      allow delete: if isAdmin();
    }
    
    // Bookings collection - Guest bookings allowed
    match /bookings/{bookingId} {
      allow read: if true; // Public read needed for checking available slots (Note: In production, consider separating PII)
      allow create: if true; // Allow guest bookings (no authentication required)
      allow update: if isSignedIn() && 
                       (resource.data.doctorId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Appointments collection
    match /appointments/{appointmentId} {
      allow read: if isSignedIn() && 
                     (resource.data.patientId == request.auth.uid || 
                      resource.data.doctorId == request.auth.uid ||
                      isAdmin());
      allow create: if isSignedIn();
      allow update: if isSignedIn() && 
                       (resource.data.patientId == request.auth.uid || 
                        resource.data.doctorId == request.auth.uid ||
                        isAdmin());
      allow delete: if isAdmin();
    }
    
    // Pending requests - Simplified permissions
    match /pendingRequests/{requestId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Doctor Requests - Anyone can submit, only admin can read/update
    match /doctorRequests/{requestId} {
      allow read: if isAdmin();
      allow create: if true; // Anyone can submit a doctor request
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Subscription Requests
    match /subscriptionRequests/{requestId} {
      allow read: if isSignedIn();
      allow create: if isDoctor();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Platform Settings - PUBLIC READ
    match /settings/{settingId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }
    
    // Subscription plans - PUBLIC READ
    match /subscriptionPlans/{planId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }
    
    // NEW Subscription Plans - PUBLIC READ
    match /subscriptionPlansNew/{planId} {
      allow read: if true; // Public read for doctors to view plans
      allow write: if isAdmin(); // Only admin can create/update/delete plans
    }
    
    // NEW Subscription Requests - Doctors can create, Admin can manage
    match /subscriptionRequestsNew/{requestId} {
      allow read: if isSignedIn(); // All signed-in users can read
      allow create: if isDoctor(); // Only doctors can create subscription requests
      allow update: if isAdmin(); // Only admin can update (approve/reject)
      allow delete: if isAdmin(); // Only admin can delete
    }
    
    // Featured Doctors - PUBLIC READ, Admin can write
    match /featuredDoctors/{doctorId} {
      allow read: if true; // Public read for homepage
      allow create: if isSignedIn(); // Any signed-in user can create (will be restricted in app)
      allow update: if isSignedIn(); // Any signed-in user can update (will be restricted in app)
      allow delete: if isSignedIn(); // Any signed-in user can delete (will be restricted in app)
    }
    
    // Specializations - PUBLIC READ
    match /specializations/{specId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }
    
    // Translations - PUBLIC READ
    match /translations/{lang} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }
    
    // Notifications
    match /notifications/{notificationId} {
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isSignedIn() || isAdmin();
      allow update: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Reviews - PUBLIC READ
    match /reviews/{reviewId} {
      allow read: if true; // Public read
      allow create: if isSignedIn();
      allow update: if isOwner(resource.data.patientId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Chats - Only doctor and patient can access
    match /chats/{chatId} {
      allow read: if isSignedIn() && 
                     (resource.data.doctorId == request.auth.uid || 
                      resource.data.patientId == request.auth.uid);
      allow create: if isSignedIn();
      allow update: if isSignedIn() && 
                       (resource.data.doctorId == request.auth.uid || 
                        resource.data.patientId == request.auth.uid);
      allow delete: if isAdmin();
      
      // Chat messages subcollection
      match /messages/{messageId} {
        allow read: if isSignedIn() && 
                       (get(/databases/$(database)/documents/chats/$(chatId)).data.doctorId == request.auth.uid || 
                        get(/databases/$(database)/documents/chats/$(chatId)).data.patientId == request.auth.uid);
        allow create: if isSignedIn() && 
                         (get(/databases/$(database)/documents/chats/$(chatId)).data.doctorId == request.auth.uid || 
                          get(/databases/$(database)/documents/chats/$(chatId)).data.patientId == request.auth.uid) &&
                         request.resource.data.senderId == request.auth.uid;
        allow update: if isSignedIn() && 
                         (get(/databases/$(database)/documents/chats/$(chatId)).data.doctorId == request.auth.uid || 
                          get(/databases/$(database)/documents/chats/$(chatId)).data.patientId == request.auth.uid);
        allow delete: if isAdmin();
      }
    }
  }
}
