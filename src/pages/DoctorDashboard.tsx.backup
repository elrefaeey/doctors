import { useState, useEffect } from 'react';
import { useLanguage } from '@/contexts/LanguageContext';
import { useAuth } from '@/contexts/AuthContext';
import {
    getAppointmentsByDoctor,
    getDoctorById,
    getDoctorPatients,
    getDoctorReviews,
    updateDoctorProfile,
    updateDoctorSchedule,
    subscribeDoctor,
    getNotificationsByUser,
    markNotificationAsRead
} from '@/services/firebaseService';
import { db } from '@/config/firebase';
import { collection, getDocs, addDoc, serverTimestamp } from 'firebase/firestore';
import {
    LayoutDashboard,
    Calendar,
    Users,
    Clock,
    CreditCard,
    Star,
    Settings,
    LogOut,
    Menu,
    X,
    TrendingUp,
    TrendingDown,
    User,
    Phone,
    MapPin,
    DollarSign,
    MessageCircle,
    Bell,
    ChevronRight,
    CheckCircle2,
    XCircle,
    Info,
    Shield
} from 'lucide-react';
import {
    LineChart,
    Line,
    XAxis,
    YAxis,
    CartesianGrid,
    Tooltip,
    ResponsiveContainer,
    AreaChart,
    Area
} from 'recharts';
import { Link, useNavigate } from 'react-router-dom';
import ChangePasswordModal from '@/components/ChangePasswordModal';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { toast } from 'sonner';
import { format } from 'date-fns';
import { ar, enUS } from 'date-fns/locale';

type Section = 'overview' | 'appointments' | 'patients' | 'schedule' | 'earnings' | 'reviews' | 'subscription' | 'settings';

const DoctorDashboard = () => {
    const { language, t, setLanguage } = useLanguage();
    const { currentUser, userData, signOut } = useAuth();
    const navigate = useNavigate();

    const [section, setSection] = useState<Section>('overview');
    const [sidebarOpen, setSidebarOpen] = useState(false);
    const [loading, setLoading] = useState(true);
    const [doctorData, setDoctorData] = useState<any>(null);
    const [appointments, setAppointments] = useState<any[]>([]);
    const [patients, setPatients] = useState<any[]>([]);
    const [reviews, setReviews] = useState<any[]>([]);
    const [plans, setPlans] = useState<any[]>([]);
    const [notifications, setNotifications] = useState<any[]>([]);
    const [isPasswordModalOpen, setIsPasswordModalOpen] = useState(false);

    // Form states
    const [profileForm, setProfileForm] = useState({
        displayName: '',
        nameAr: '',
        bio: '',
        phone: '',
        clinicAddress: '',
        consultationPrice: 0,
        specialization: '',
        governorate: '',
        showInSearch: true
    });

    const [scheduleForm, setScheduleForm] = useState<any>({
        workingDays: [],
        startTime: '09:00',
        endTime: '17:00',
        appointmentDuration: 30
    });

    useEffect(() => {
        if (currentUser) {
            fetchDashboardData();
        }
    }, [currentUser]);

    const fetchDashboardData = async () => {
        setLoading(true);
        try {
            const [docInfo, appts, pts, revs, notifs] = await Promise.all([
                getDoctorById(currentUser!.uid),
                getAppointmentsByDoctor(currentUser!.uid),
                getDoctorPatients(currentUser!.uid),
                getDoctorReviews(currentUser!.uid),
                getNotificationsByUser(currentUser!.uid)
            ]);

            setDoctorData(docInfo);
            setAppointments(appts);
            setPatients(pts);
            setReviews(revs);
            setNotifications(notifs);

            // Fetch subscription plans from subscriptionPlansNew
            const plansSnapshot = await getDocs(collection(db, 'subscriptionPlansNew'));
            const plansData = plansSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setPlans(plansData);

            if (docInfo) {
                setProfileForm({
                    displayName: docInfo.displayName || '',
                    nameAr: docInfo.nameAr || '',
                    bio: docInfo.bio || '',
                    phone: docInfo.phone || '',
                    clinicAddress: docInfo.clinicAddress || '',
                    consultationPrice: docInfo.consultationPrice || 0,
                    specialization: docInfo.specialization || '',
                    governorate: docInfo.governorate || '',
                    showInSearch: docInfo.showInSearch !== false
                });
                setScheduleForm(docInfo.schedule || {
                    workingDays: [],
                    startTime: '09:00',
                    endTime: '17:00',
                    appointmentDuration: 30
                });
            }
        } catch (error) {
            console.error("Error fetching dashboard data:", error);
            toast.error(t('errors.somethingWentWrong'));
        } finally {
            setLoading(false);
        }
    };

    const handleLogout = async () => {
        try {
            await signOut();
            navigate('/login/doctor');
        } catch (error) {
            toast.error("Logout failed");
        }
    };

    const handleUpdateProfile = async (e: React.FormEvent) => {
        e.preventDefault();
        try {
            await updateDoctorProfile(currentUser!.uid, profileForm);
            toast.success(t('success.profileUpdated'));
            fetchDashboardData();
        } catch (error) {
            toast.error(t('errors.somethingWentWrong'));
        }
    };

    const handleUpdateSchedule = async () => {
        try {
            await updateDoctorSchedule(currentUser!.uid, scheduleForm);
            toast.success(t('common.success'));
            fetchDashboardData();
        } catch (error) {
            toast.error(t('errors.somethingWentWrong'));
        }
    };

    const handleSelectPlan = async (plan: any) => {
        try {
            await subscribeDoctor(currentUser!.uid, plan);
            toast.success(t('common.success'));
            fetchDashboardData();
        } catch (error) {
            toast.error(t('errors.somethingWentWrong'));
        }
    };

    const specializations = [
        'طب الأسنان', 'طب الأطفال', 'الجراحة العامة', 'طب العيون', 'طب الأنف والأذن والحنجرة',
        'طب القلب', 'طب الجلدية', 'طب النساء والتوليد', 'طب العظام', 'الطب النفسي'
    ];

    const governorates = [
        'القاهرة', 'الجيزة', 'الإسكندرية', 'الدقهلية', 'البحر الأحمر', 'البحيرة', 'الفيوم',
        'الغربية', 'الإسماعيلية', 'المنوفية', 'المنيا', 'القليوبية', 'الوادي الجديد', 'الشرقية',
        'السويس', 'أسوان', 'أسيوط', 'بني سويف', 'بورسعيد', 'دمياط', 'الأقصر', 'قنا',
        'كفر الشيخ', 'مطروح', 'سوهاج', 'شمال سيناء', 'جنوب سيناء'
    ];

    const sidebarItems = [
        { key: 'overview', label: t('doctorDash.overview'), icon: LayoutDashboard },
        { key: 'appointments', label: t('doctorDash.appointments'), icon: Calendar },
        { key: 'patients', label: t('doctorDash.patients'), icon: Users },
        { key: 'earnings', label: t('doctorDash.earnings'), icon: DollarSign },
        { key: 'schedule', label: t('doctorDash.schedule'), icon: Clock },
        { key: 'reviews', label: t('doctorDash.reviews'), icon: Star },
        { key: 'subscription', label: t('doctorDash.subscription'), icon: CreditCard },
        { key: 'chat', label: language === 'ar' ? 'المحادثات' : 'Chat', icon: MessageCircle },
        { key: 'settings', label: t('doctorDash.settings'), icon: Settings },
    ];

    if (loading) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-[#f8faff]">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                    <p className="text-muted-foreground">{t('common.loading')}</p>
                </div>
            </div>
        );
    }

    const unreadNotifications = notifications.filter(n => !n.read).length;

    // Chart data preparation - Start from zero for new doctors
    const visitsData = [
        { name: 'Mon', visits: 0 },
        { name: 'Tue', visits: 0 },
        { name: 'Wed', visits: 0 },
        { name: 'Thu', visits: 0 },
        { name: 'Fri', visits: 0 },
        { name: 'Sat', visits: 0 },
        { name: 'Sun', visits: 0 },
    ];

    const earningsData = [
        { name: 'Jan', amount: 0 },
        { name: 'Feb', amount: 0 },
        { name: 'Mar', amount: 0 },
        { name: 'Apr', amount: 0 },
        { name: 'May', amount: 0 },
        { name: 'Jun', amount: 0 },
    ];

    return (
        <div className="min-h-screen bg-[#f8faff] flex font-sans overflow-x-hidden" dir={language === 'ar' ? 'rtl' : 'ltr'}>
            {/* Sidebar */}
            <aside className={`fixed inset-y-0 ${language === 'ar' ? 'right-0' : 'left-0'} z-50 w-72 bg-white border-x border-slate-100 shadow-xl transition-transform duration-300 lg:translate-x-0 ${sidebarOpen ? 'translate-x-0' : (language === 'ar' ? 'translate-x-full' : '-translate-x-full')}`}>
                <div className="h-full flex flex-col">
                    <div className="p-6 border-b border-slate-50 flex items-center justify-between">
                        <Link to="/" className="flex items-center gap-2">
                            <div className="w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center text-white shadow-lg shadow-blue-200">
                                <Shield size={24} />
                            </div>
                            <span className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-blue-500">
                                {t('common.appName')}
                            </span>
                        </Link>
                        <button onClick={() => setSidebarOpen(false)} className="lg:hidden p-2 text-slate-400 hover:text-slate-600">
                            <X size={20} />
                        </button>
                    </div>

                    <nav className="flex-1 px-4 py-8 space-y-1">
                        {sidebarItems.map(item => (
                            <button
                                key={item.key}
                                onClick={() => { 
                                    if (item.key === 'settings') {
                                        navigate('/doctor/settings');
                                    } else if (item.key === 'chat') {
                                        navigate('/chat');
                                    } else {
                                        setSection(item.key as Section); 
                                        setSidebarOpen(false);
                                    }
                                }}
                                className={`w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl text-[15px] font-medium transition-all duration-200 group ${section === item.key
                                    ? 'bg-blue-50 text-blue-700 shadow-sm'
                                    : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900'
                                    }`}
                            >
                                <item.icon size={20} className={section === item.key ? 'text-blue-600' : 'text-slate-400 group-hover:text-slate-600'} />
                                {item.label}
                                {section === item.key && <div className={`absolute ${language === 'ar' ? 'start-0' : 'end-0'} w-1 h-6 bg-blue-600 rounded-full`} />}
                            </button>
                        ))}
                    </nav>

                    <div className="p-4 border-t border-slate-50 mt-auto">
                        <button onClick={handleLogout} className="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl text-rose-600 font-medium hover:bg-rose-50 transition-colors">
                            <LogOut size={20} />
                            {t('nav.logout')}
                        </button>
                    </div>
                </div>
            </aside>

            {/* Main Content */}
            <main className={`flex-1 min-h-screen transition-all duration-300 lg:ms-72 ${sidebarOpen ? 'overflow-hidden' : ''}`}>
                {/* Overlay for mobile sidebar */}
                {sidebarOpen && (
                    <div
                        className="fixed inset-0 bg-black/20 backdrop-blur-sm z-40 lg:hidden"
                        onClick={() => setSidebarOpen(false)}
                    />
                )}
                {/* Header */}
                <header className="h-20 bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-slate-100 flex items-center justify-between px-6 lg:px-10">
                    <div className="flex items-center gap-4">
                        <button onClick={() => setSidebarOpen(true)} className="lg:hidden p-2 text-slate-500 bg-slate-50 rounded-xl">
                            <Menu size={20} />
                        </button>
                        <h1 className="text-xl font-bold text-slate-900">
                            {sidebarItems.find(i => i.key === section)?.label}
                        </h1>
                    </div>

                    <div className="flex items-center gap-4 lg:gap-8">
                        {/* Language Switcher */}
                        <div className="bg-slate-100 p-1 rounded-xl hidden sm:flex">
                            <button
                                onClick={() => setLanguage('en')}
                                className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${language === 'en' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}
                            >
                                EN
                            </button>
                            <button
                                onClick={() => setLanguage('ar')}
                                className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${language === 'ar' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}
                            >
                                AR
                            </button>
                        </div>

                        {/* Notifications */}
                        <div className="relative group cursor-pointer">
                            <div className="p-2.5 bg-slate-50 rounded-xl text-slate-600 hover:bg-slate-100 transition-colors">
                                <Bell size={20} />
                                {unreadNotifications > 0 && (
                                    <span className="absolute top-1 right-1 w-5 h-5 bg-rose-500 text-white text-[10px] font-bold flex items-center justify-center rounded-full border-2 border-white">
                                        {unreadNotifications}
                                    </span>
                                )}
                            </div>
                        </div>

                        {/* Profile Info */}
                        <div className="flex items-center gap-3 ps-4 border-s border-slate-100">
                            <div className="text-right hidden md:block">
                                <p className="text-sm font-bold text-slate-900">{language === 'ar' ? doctorData?.nameAr : doctorData?.displayName}</p>
                                <p className="text-[11px] text-slate-500 font-medium uppercase tracking-wider">{userData?.role}</p>
                            </div>
                            <div className="w-11 h-11 rounded-xl bg-blue-100 flex items-center justify-center text-blue-700 font-bold border-2 border-white shadow-soft">
                                {doctorData?.photoURL ? (
                                    <img src={doctorData.photoURL} alt="Doctor" className="w-full h-full object-cover rounded-xl" />
                                ) : (
                                    doctorData?.displayName?.charAt(0) || 'D'
                                )}
                            </div>
                        </div>
                    </div>
                </header>

                <div className="p-4 md:p-6 lg:p-10 max-w-7xl mx-auto">
                    {/* Content Sections */}
                    {section === 'overview' && (
                        <div className="space-y-6 md:space-y-8 animate-in fade-in duration-500">
                            {/* Stats Cards - Enhanced Mobile Design */}
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                                {/* Today's Appointments */}
                                <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl md:rounded-3xl p-6 md:p-8 text-white shadow-lg">
                                    <div className="flex items-start justify-between mb-4">
                                        <div className="w-12 h-12 md:w-14 md:h-14 rounded-xl md:rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                                            <Calendar size={24} className="md:w-7 md:h-7" />
                                        </div>
                                    </div>
                                    <div className="text-4xl md:text-5xl font-black mb-2">
                                        {appointments.filter(a => a.date === format(new Date(), 'yyyy-MM-dd')).length}
                                    </div>
                                    <div className="text-sm md:text-base text-white/90 font-medium">
                                        {t('doctorDash.stats.todayAppts')}
                                    </div>
                                </div>

                                {/* This Month */}
                                <div className="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl md:rounded-3xl p-6 md:p-8 text-white shadow-lg">
                                    <div className="flex items-start justify-between mb-4">
                                        <div className="w-12 h-12 md:w-14 md:h-14 rounded-xl md:rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                                            <Clock size={24} className="md:w-7 md:h-7" />
                                        </div>
                                    </div>
                                    <div className="text-4xl md:text-5xl font-black mb-2">
                                        {appointments.filter(a => a.date.startsWith(format(new Date(), 'yyyy-MM'))).length}
                                    </div>
                                    <div className="text-sm md:text-base text-white/90 font-medium">
                                        {t('doctorDash.stats.thisMonthAppts')}
                                    </div>
                                </div>

                                {/* Total Patients */}
                                <div className="bg-gradient-to-br from-amber-500 to-amber-600 rounded-2xl md:rounded-3xl p-6 md:p-8 text-white shadow-lg">
                                    <div className="flex items-start justify-between mb-4">
                                        <div className="w-12 h-12 md:w-14 md:h-14 rounded-xl md:rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                                            <Users size={24} className="md:w-7 md:h-7" />
                                        </div>
                                    </div>
                                    <div className="text-4xl md:text-5xl font-black mb-2">
                                        {patients.length}
                                    </div>
                                    <div className="text-sm md:text-base text-white/90 font-medium">
                                        {t('doctorDash.stats.totalPatients')}
                                    </div>
                                </div>

                                {/* Average Rating */}
                                <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl md:rounded-3xl p-6 md:p-8 text-white shadow-lg">
                                    <div className="flex items-start justify-between mb-4">
                                        <div className="w-12 h-12 md:w-14 md:h-14 rounded-xl md:rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                                            <Star size={24} className="md:w-7 md:h-7" fill="currentColor" />
                                        </div>
                                    </div>
                                    <div className="text-4xl md:text-5xl font-black mb-2">
                                        {doctorData?.rating || '0.0'}
                                    </div>
                                    <div className="text-sm md:text-base text-white/90 font-medium">
                                        {t('doctorDash.stats.avgRating')}
                                    </div>
                                </div>
                            </div>

                            {/* Chart & Recent Activity */}
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                                    bg="bg-amber-50"
                                />
                                <StatCard
                                    label={t('doctorDash.stats.totalEarnings')}
                                    value={`$${doctorData?.totalEarnings || 0}`}
                                    icon={DollarSign}
                                    color="text-purple-600"
                                    bg="bg-purple-50"
                                />
                            </div>

                            {/* Chart & Recent Activity */}
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div className="lg:col-span-2 bg-white rounded-3xl border border-slate-100 p-8 shadow-soft">
                                    <div className="flex items-center justify-between mb-8">
                                        <h3 className="text-lg font-bold text-slate-900">{t('doctorDash.charts.visitsTrend')}</h3>
                                        <select className="bg-slate-50 border-none text-xs font-bold rounded-lg px-3 py-1.5 focus:ring-0">
                                            <option>Weekly</option>
                                            <option>Monthly</option>
                                        </select>
                                    </div>
                                    <div className="h-[300px] w-full">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <AreaChart data={visitsData}>
                                                <defs>
                                                    <linearGradient id="colorVisits" x1="0" y1="0" x2="0" y2="1">
                                                        <stop offset="5%" stopColor="#2563eb" stopOpacity={0.1} />
                                                        <stop offset="95%" stopColor="#2563eb" stopOpacity={0} />
                                                    </linearGradient>
                                                </defs>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{ fill: '#94a3b8', fontSize: 12 }} dy={10} />
                                                <YAxis axisLine={false} tickLine={false} tick={{ fill: '#94a3b8', fontSize: 12 }} />
                                                <Tooltip
                                                    contentStyle={{ borderRadius: '16px', border: 'none', boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1)' }}
                                                />
                                                <Area type="monotone" dataKey="visits" stroke="#2563eb" strokeWidth={3} fillOpacity={1} fill="url(#colorVisits)" />
                                            </AreaChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                <div className="bg-white rounded-3xl border border-slate-100 p-8 shadow-soft">
                                    <h3 className="text-lg font-bold text-slate-900 mb-6">{t('doctorDash.reviews')}</h3>
                                    <div className="flex items-center gap-4 mb-8 p-4 bg-slate-50 rounded-2xl">
                                        <div className="text-3xl font-black text-blue-600">{doctorData?.rating || '0.0'}</div>
                                        <div>
                                            <div className="flex text-amber-400">
                                                {[...Array(5)].map((_, i) => <Star key={i} size={16} fill={i < Math.floor(doctorData?.rating || 0) ? "currentColor" : "none"} />)}
                                            </div>
                                            <p className="text-xs text-slate-400 font-bold mt-1 uppercase tracking-tighter">{t('doctorDash.stats.avgRating')}</p>
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        {reviews.slice(0, 3).map((review) => (
                                            <div key={review.id} className="p-4 rounded-2xl border border-slate-50 hover:bg-slate-50/50 transition-colors">
                                                <div className="flex justify-between items-start mb-2">
                                                    <p className="text-sm font-bold text-slate-900">{review.patientName}</p>
                                                    <div className="flex text-amber-400"><Star size={12} fill="currentColor" /> <span className="text-xs font-bold ms-1">{review.rating}</span></div>
                                                </div>
                                                <p className="text-[13px] text-slate-500 line-clamp-2 leading-relaxed">{review.comment}</p>
                                            </div>
                                        ))}
                                        <button onClick={() => setSection('reviews')} className="w-full text-center py-2 text-sm font-bold text-blue-600 hover:underline">
                                            {t('home.viewAll')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {section === 'appointments' && (
                        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-white p-6 rounded-3xl border border-slate-100 shadow-soft">
                                <div>
                                    <h3 className="text-lg font-bold text-slate-900">{t('doctorDash.appointments')}</h3>
                                    <p className="text-sm text-slate-500">{appointments.length} total scheduled</p>
                                </div>
                                <div className="flex gap-2">
                                    <Button variant="outline" className="rounded-xl border-slate-200 text-slate-600 h-11 px-6">Filter</Button>
                                    <Button className="rounded-xl bg-blue-600 hover:bg-blue-700 h-11 px-6 shadow-lg shadow-blue-100">Today</Button>
                                </div>
                            </div>

                            <div className="bg-white rounded-3xl border border-slate-100 shadow-soft overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b border-slate-50 bg-slate-50/50">
                                                <th className="px-4 sm:px-6 py-4 sm:py-5 text-start font-bold text-slate-600 uppercase tracking-wider text-[11px] min-w-[120px]">{t('doctorDash.appointmentsTable.patientName')}</th>
                                                <th className="px-4 sm:px-6 py-4 sm:py-5 text-start font-bold text-slate-600 uppercase tracking-wider text-[11px] min-w-[100px]">{t('doctorDash.appointmentsTable.date')}</th>
                                                <th className="px-4 sm:px-6 py-4 sm:py-5 text-start font-bold text-slate-600 uppercase tracking-wider text-[11px]">{t('doctorDash.appointmentsTable.time')}</th>
                                                <th className="px-4 sm:px-6 py-4 sm:py-5 text-start font-bold text-slate-600 uppercase tracking-wider text-[11px]">{t('doctorDash.appointmentsTable.status')}</th>
                                                <th className="px-4 sm:px-6 py-4 sm:py-5 text-end font-bold text-slate-600 uppercase tracking-wider text-[11px]">{t('doctorDash.appointmentsTable.actions')}</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-50">
                                            {appointments.map((appt) => (
                                                <tr key={appt.id} className="hover:bg-slate-50/50 transition-colors group">
                                                    <td className="px-4 sm:px-6 py-4 sm:py-5">
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-10 h-10 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500 font-bold border-2 border-white group-hover:bg-white group-hover:shadow-soft">
                                                                {appt.patientName.charAt(0)}
                                                            </div>
                                                            <span className="font-bold text-slate-900">{appt.patientName}</span>
                                                        </div>
                                                    </td>
                                                    <td className="px-4 sm:px-6 py-4 sm:py-5 text-slate-600 font-medium">
                                                        {format(new Date(appt.date), 'dd MMM yyyy', { locale: language === 'ar' ? ar : enUS })}
                                                    </td>
                                                    <td className="px-4 sm:px-6 py-4 sm:py-5">
                                                        <div className="flex items-center gap-1.5 text-slate-600 font-bold">
                                                            <Clock size={14} className="text-slate-400" />
                                                            {appt.time}
                                                        </div>
                                                    </td>
                                                    <td className="px-4 sm:px-6 py-4 sm:py-5">
                                                        <StatusBadge status={appt.status} />
                                                    </td>
                                                    <td className="px-4 sm:px-6 py-4 sm:py-5 text-end">
                                                        <div className="flex justify-end gap-2">
                                                            <button className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-all" title={t('doctorDash.appointmentsTable.openChat')}>
                                                                <MessageCircle size={18} />
                                                            </button>
                                                            <button className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-all" title={t('doctorDash.appointmentsTable.openDetails')}>
                                                                <Info size={18} />
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                            {appointments.length === 0 && (
                                                <tr>
                                                    <td colSpan={5} className="px-6 py-20 text-center text-slate-400 italic">No appointments found</td>
                                                </tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}

                    {section === 'patients' && (
                        <div className="space-y-6 animate-in fade-in duration-500">
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {patients.map((patient) => (
                                    <div key={patient.id} className="bg-white p-6 rounded-3xl border border-slate-100 shadow-soft hover:shadow-md transition-all group">
                                        <div className="flex items-start justify-between mb-6">
                                            <div className="flex items-center gap-4">
                                                <div className="w-14 h-14 rounded-2xl bg-slate-50 flex items-center justify-center text-slate-400 text-xl font-black border-2 border-white shadow-soft group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors">
                                                    {patient.displayName ? patient.displayName.charAt(0) : 'P'}
                                                </div>
                                                <div>
                                                    <h4 className="font-bold text-slate-900 group-hover:text-blue-600 transition-colors">{patient.displayName || 'Patient'}</h4>
                                                    <p className="text-xs text-slate-400 font-medium flex items-center gap-1">
                                                        <Phone size={10} /> {patient.phone || 'No phone'}
                                                    </p>
                                                </div>
                                            </div>
                                            <button className="p-2 text-slate-300 hover:text-slate-600 rounded-lg">
                                                <ChevronRight size={18} />
                                            </button>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4 border-t border-slate-50 pt-6">
                                            <div>
                                                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">{t('doctorDash.patientsTable.totalVisits')}</p>
                                                <p className="text-sm font-black text-slate-900">{patient.totalVisits || 1}</p>
                                            </div>
                                            <div>
                                                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">{t('doctorDash.patientsTable.lastVisit')}</p>
                                                <p className="text-sm font-bold text-slate-900">
                                                    {patient.lastVisit ? format(new Date(patient.lastVisit), 'dd MMM') : '-'}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {section === 'schedule' && (
                        <div className="max-w-4xl animate-in fade-in slide-in-from-top-4 duration-500">
                            <div className="bg-white rounded-3xl border border-slate-100 shadow-soft p-8 sm:p-10">
                                <h3 className="text-xl font-black text-slate-900 mb-2">{t('doctorDash.scheduleManagement.workingDays')}</h3>
                                <p className="text-sm text-slate-500 mb-10">
                                    {language === 'ar' ? 'اختر الأيام التي يمكن للمرضى حجز مواعيد فيها' : 'Select when patients can book appointments with you'}
                                </p>

                                <div className="space-y-10">
                                    <div className="flex flex-wrap gap-3">
                                        {['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].map((day) => {
                                            const isSelected = scheduleForm.workingDays.includes(day);
                                            const dayNames: Record<string, { ar: string; en: string }> = {
                                                'Monday': { ar: 'الاثنين', en: 'Monday' },
                                                'Tuesday': { ar: 'الثلاثاء', en: 'Tuesday' },
                                                'Wednesday': { ar: 'الأربعاء', en: 'Wednesday' },
                                                'Thursday': { ar: 'الخميس', en: 'Thursday' },
                                                'Friday': { ar: 'الجمعة', en: 'Friday' },
                                                'Saturday': { ar: 'السبت', en: 'Saturday' },
                                                'Sunday': { ar: 'الأحد', en: 'Sunday' }
                                            };
                                            return (
                                                <button
                                                    key={day}
                                                    onClick={() => {
                                                        const newDays = isSelected
                                                            ? scheduleForm.workingDays.filter((d: string) => d !== day)
                                                            : [...scheduleForm.workingDays, day];
                                                        setScheduleForm({ ...scheduleForm, workingDays: newDays });
                                                    }}
                                                    className={`px-6 py-3 rounded-2xl text-sm font-bold transition-all ${isSelected
                                                        ? 'bg-blue-600 text-white shadow-lg shadow-blue-100'
                                                        : 'bg-slate-50 text-slate-500 hover:bg-slate-100'}`}
                                                >
                                                    {language === 'ar' ? dayNames[day].ar : dayNames[day].en}
                                                </button>
                                            )
                                        })}
                                    </div>

                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-8 p-8 bg-slate-50 rounded-3xl border border-slate-100 border-dashed">
                                        <div className="space-y-3">
                                            <Label className="text-xs font-black text-slate-600 uppercase tracking-widest">{t('doctorDash.scheduleManagement.startTime')}</Label>
                                            <div className="relative">
                                                <Clock className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                                                <Input
                                                    type="time"
                                                    className="ps-12 h-14 rounded-2xl border-white bg-white shadow-sm font-bold text-slate-900"
                                                    value={scheduleForm.startTime}
                                                    onChange={e => setScheduleForm({ ...scheduleForm, startTime: e.target.value })}
                                                />
                                            </div>
                                        </div>
                                        <div className="space-y-3">
                                            <Label className="text-xs font-black text-slate-600 uppercase tracking-widest">{t('doctorDash.scheduleManagement.endTime')}</Label>
                                            <div className="relative">
                                                <Clock className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                                                <Input
                                                    type="time"
                                                    className="ps-12 h-14 rounded-2xl border-white bg-white shadow-sm font-bold text-slate-900"
                                                    value={scheduleForm.endTime}
                                                    onChange={e => setScheduleForm({ ...scheduleForm, endTime: e.target.value })}
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Appointment Duration */}
                                    <div className="p-8 bg-blue-50 rounded-3xl border border-blue-100">
                                        <Label className="text-xs font-black text-slate-600 uppercase tracking-widest mb-4 block">
                                            {language === 'ar' ? 'مدة الموعد' : 'Appointment Duration'}
                                        </Label>
                                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                            {[15, 30, 45, 60].map(duration => (
                                                <button
                                                    key={duration}
                                                    type="button"
                                                    onClick={() => setScheduleForm({ ...scheduleForm, appointmentDuration: duration })}
                                                    className={`p-4 rounded-xl border-2 transition-all font-bold ${
                                                        scheduleForm.appointmentDuration === duration
                                                            ? 'border-blue-600 bg-blue-600 text-white shadow-lg'
                                                            : 'border-white bg-white text-slate-700 hover:border-blue-300'
                                                    }`}
                                                >
                                                    {duration} {language === 'ar' ? 'دقيقة' : 'min'}
                                                </button>
                                            ))}
                                        </div>
                                        <p className="text-xs text-slate-500 mt-3">
                                            {language === 'ar' 
                                                ? 'حدد المدة الزمنية لكل موعد. سيتم تقسيم ساعات العمل تلقائياً بناءً على هذه المدة.'
                                                : 'Set the duration for each appointment. Working hours will be automatically divided based on this duration.'
                                            }
                                        </p>
                                    </div>

                                    <div className="flex justify-end pt-6 border-t border-slate-50">
                                        <Button
                                            onClick={handleUpdateSchedule}
                                            className="h-14 px-10 rounded-2xl bg-blue-600 hover:bg-blue-700 text-white font-bold shadow-xl shadow-blue-100 active:scale-95 transition-all"
                                        >
                                            {t('doctorDash.scheduleManagement.saveSchedule')}
                                        </Button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {section === 'earnings' && (
                        <div className="space-y-8 animate-in fade-in duration-500">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="bg-gradient-to-br from-blue-700 to-blue-500 p-8 rounded-[40px] text-white shadow-xl shadow-blue-200">
                                    <div className="flex items-center justify-between mb-8">
                                        <p className="text-sm font-bold opacity-80 uppercase tracking-widest">{t('doctorDash.earningsPage.total')}</p>
                                        <div className="p-3 bg-white/10 rounded-2xl backdrop-blur-md">
                                            <TrendingUp size={24} />
                                        </div>
                                    </div>
                                    <h4 className="text-4xl font-black mb-2">${doctorData?.totalEarnings || 0}</h4>
                                    <p className="text-sm font-medium opacity-60">+12% from last month</p>
                                </div>

                                <StatCard
                                    label={t('doctorDash.earningsPage.thisMonth')}
                                    value={`$${(doctorData?.totalEarnings || 0) * 0.3}`}
                                    icon={DollarSign}
                                    color="text-emerald-600"
                                    bg="bg-emerald-50"
                                />
                                <StatCard
                                    label={t('doctorDash.earningsPage.completedSessions')}
                                    value={appointments.filter(a => a.status === 'completed').length}
                                    icon={CheckCircle2}
                                    color="text-blue-600"
                                    bg="bg-blue-50"
                                />
                            </div>

                            <div className="bg-white rounded-3xl border border-slate-100 p-8 shadow-soft">
                                <h3 className="text-lg font-bold text-slate-900 mb-8">{t('doctorDash.charts.earningsTrend')}</h3>
                                <div className="h-[350px]">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <LineChart data={earningsData}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                            <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{ fill: '#94a3b8' }} dy={10} />
                                            <YAxis axisLine={false} tickLine={false} tick={{ fill: '#94a3b8' }} />
                                            <Tooltip />
                                            <Line type="monotone" dataKey="amount" stroke="#2563eb" strokeWidth={4} dot={{ r: 6, fill: '#2563eb', strokeWidth: 3, stroke: '#fff' }} activeDot={{ r: 8 }} />
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </div>
                    )}

                    {section === 'reviews' && (
                        <div className="space-y-6 animate-in fade-in duration-500">
                            <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                                <div className="lg:col-span-1 bg-white p-8 rounded-3xl border border-slate-100 shadow-soft h-fit sticky top-24">
                                    <h3 className="text-xl font-black text-slate-900 mb-6 font-display">{t('doctorDash.reviews')}</h3>
                                    <div className="flex flex-col items-center py-10 bg-blue-50/50 rounded-3xl border border-blue-100/50">
                                        <span className="text-6xl font-black text-blue-600 mb-2">{doctorData?.rating || '0.0'}</span>
                                        <div className="flex text-amber-400 gap-1 mb-3">
                                            {[...Array(5)].map((_, i) => <Star key={i} size={20} fill={i < Math.floor(doctorData?.rating || 0) ? "currentColor" : "none"} />)}
                                        </div>
                                        <p className="text-xs text-blue-400 font-bold uppercase tracking-widest">{t('doctorDash.stats.avgRating')}</p>
                                    </div>
                                    <div className="mt-8 space-y-4">
                                        {[5, 4, 3, 2, 1].map(star => (
                                            <div key={star} className="flex items-center gap-4">
                                                <span className="text-xs font-bold text-slate-500 w-4">{star}</span>
                                                <div className="flex-1 h-2 bg-slate-50 rounded-full overflow-hidden">
                                                    <div
                                                        className="h-full bg-amber-400 rounded-full"
                                                        style={{ width: `${star === 5 ? 70 : star === 4 ? 20 : 5}%` }}
                                                    />
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="lg:col-span-3 space-y-4">
                                    {reviews.map((review) => (
                                        <div key={review.id} className="bg-white p-8 rounded-[32px] border border-slate-100 shadow-soft hover:shadow-md transition-shadow group">
                                            <div className="flex items-start justify-between mb-6">
                                                <div className="flex items-center gap-4">
                                                    <div className="w-12 h-12 rounded-2xl bg-slate-50 flex items-center justify-center text-slate-500 font-black border-2 border-white shadow-soft group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors">
                                                        {review.patientName.charAt(0)}
                                                    </div>
                                                    <div>
                                                        <h4 className="font-bold text-slate-900">{review.patientName}</h4>
                                                        <p className="text-[11px] text-slate-400 font-bold">{format(review.createdAt, 'dd MMM yyyy')}</p>
                                                    </div>
                                                </div>
                                                <div className="flex text-amber-400 gap-1">
                                                    {[...Array(5)].map((_, i) => <Star key={i} size={14} fill={i < review.rating ? "currentColor" : "none"} />)}
                                                </div>
                                            </div>
                                            <p className="text-slate-600 leading-relaxed text-[15px]">{review.comment}</p>
                                            <div className="mt-6 pt-6 border-t border-slate-50 flex justify-end">
                                                <Button variant="ghost" className="text-blue-600 font-bold text-xs rounded-xl hover:bg-blue-50">Reply</Button>
                                            </div>
                                        </div>
                                    ))}
                                    {reviews.length === 0 && (
                                        <div className="text-center py-20 bg-white rounded-3xl border border-dashed text-slate-400">
                                            No reviews yet
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {section === 'subscription' && (
                        <div className="space-y-10 animate-in fade-in duration-500">
                            <div className="bg-gradient-to-r from-blue-700 to-blue-500 rounded-[40px] p-10 lg:p-14 text-white relative overflow-hidden shadow-2xl shadow-blue-200">
                                <div className="relative z-10 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-10">
                                    <div className="space-y-4">
                                        <div className="inline-flex items-center gap-2 px-4 py-2 bg-white/10 rounded-full backdrop-blur-md text-xs font-black uppercase tracking-widest border border-white/20">
                                            <Shield size={14} /> {t('doctorDash.subscriptionPage.current')}
                                        </div>
                                        <h2 className="text-5xl font-black">{doctorData?.subscription?.planName || 'Silver'} Plan</h2>
                                        <p className="text-lg opacity-80 font-medium max-w-md">Enjoy premium visibility and priority in patient search results.</p>
                                    </div>
                                    <div className="bg-white/10 backdrop-blur-xl rounded-3xl p-8 border border-white/20 w-full lg:w-96">
                                        <div className="space-y-6">
                                            <div className="flex justify-between items-center">
                                                <span className="text-sm font-bold opacity-70">{t('doctorDash.subscriptionPage.status')}</span>
                                                <span className="px-3 py-1 bg-emerald-400/20 text-emerald-300 rounded-lg text-xs font-black uppercase tracking-widest border border-emerald-400/30">
                                                    {t('doctorDash.subscriptionPage.active')}
                                                </span>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-sm font-bold opacity-70">{t('doctorDash.subscriptionPage.expiry')}</span>
                                                <span className="text-sm font-black">
                                                    {doctorData?.subscription?.endDate ? format(doctorData.subscription.endDate.toDate(), 'dd MMM yyyy') : 'Never'}
                                                </span>
                                            </div>
                                            <div className="pt-4 border-t border-white/10 flex justify-between items-center">
                                                <span className="text-sm font-bold opacity-70">{t('doctorDash.subscriptionPage.remaining')}</span>
                                                <span className="text-3xl font-black">24 Days</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {/* Abstract background circles */}
                                <div className="absolute top-[-100px] right-[-100px] w-80 h-80 bg-white/5 rounded-full blur-3xl shadow-soft" />
                                <div className="absolute bottom-[-100px] left-[-100px] w-80 h-80 bg-blue-400/10 rounded-full blur-3xl shadow-soft" />
                            </div>

                            <div className="space-y-6">
                                <h3 className="text-2xl font-black text-slate-900 px-2">{t('doctorDash.subscriptionPage.availablePlans')}</h3>
                                {plans.length === 0 ? (
                                    <div className="text-center py-20 bg-white rounded-3xl border border-dashed border-slate-200">
                                        <p className="text-slate-400">
                                            {language === 'ar' ? 'لا توجد خطط متاحة حالياً' : 'No plans available at the moment'}
                                        </p>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                        {plans.map((plan: any) => {
                                            const planName = language === 'ar' ? plan.nameAr : plan.nameEn;
                                            const planDesc = language === 'ar' ? plan.descriptionAr : plan.descriptionEn;
                                            
                                            return (
                                                <div 
                                                    key={plan.id} 
                                                    className="bg-white rounded-3xl border-2 border-slate-100 p-8 flex flex-col shadow-lg hover:shadow-2xl transition-all relative overflow-hidden group hover:scale-105"
                                                    style={{ borderColor: plan.color || '#e2e8f0' }}
                                                >
                                                    {/* Icon */}
                                                    <div className="text-5xl mb-4">{plan.icon || '📦'}</div>
                                                    
                                                    {/* Badges */}
                                                    <div className="flex gap-2 mb-4">
                                                        {plan.isPopular && (
                                                            <span className="px-3 py-1 bg-orange-100 text-orange-600 text-xs font-bold rounded-full">
                                                                {language === 'ar' ? '🔥 الأكثر شعبية' : '🔥 Popular'}
                                                            </span>
                                                        )}
                                                        {plan.isRecommended && (
                                                            <span className="px-3 py-1 bg-blue-100 text-blue-600 text-xs font-bold rounded-full">
                                                                {language === 'ar' ? '⭐ موصى به' : '⭐ Recommended'}
                                                            </span>
                                                        )}
                                                    </div>

                                                    {/* Plan Name */}
                                                    <h4 className="text-2xl font-black text-slate-900 mb-2">{planName}</h4>
                                                    
                                                    {/* Description */}
                                                    <p className="text-sm text-slate-500 mb-6 leading-relaxed">{planDesc}</p>

                                                    {/* Durations */}
                                                    <div className="space-y-3 mb-6">
                                                        {plan.durations?.monthly?.enabled && (
                                                            <div className="flex justify-between items-center p-3 bg-slate-50 rounded-xl">
                                                                <span className="text-sm font-semibold">
                                                                    {language === 'ar' ? 'شهري (30 يوم)' : 'Monthly (30 days)'}
                                                                </span>
                                                                <span className="text-lg font-black text-blue-600">
                                                                    {plan.durations.monthly.price} {language === 'ar' ? 'ج.م' : 'EGP'}
                                                                </span>
                                                            </div>
                                                        )}
                                                        {plan.durations?.sixMonths?.enabled && (
                                                            <div className="flex justify-between items-center p-3 bg-slate-50 rounded-xl">
                                                                <span className="text-sm font-semibold">
                                                                    {language === 'ar' ? '6 أشهر (180 يوم)' : '6 Months (180 days)'}
                                                                </span>
                                                                <span className="text-lg font-black text-blue-600">
                                                                    {plan.durations.sixMonths.price} {language === 'ar' ? 'ج.م' : 'EGP'}
                                                                </span>
                                                            </div>
                                                        )}
                                                        {plan.durations?.yearly?.enabled && (
                                                            <div className="flex justify-between items-center p-3 bg-slate-50 rounded-xl">
                                                                <span className="text-sm font-semibold">
                                                                    {language === 'ar' ? 'سنوي (365 يوم)' : 'Yearly (365 days)'}
                                                                </span>
                                                                <span className="text-lg font-black text-blue-600">
                                                                    {plan.durations.yearly.price} {language === 'ar' ? 'ج.م' : 'EGP'}
                                                                </span>
                                                            </div>
                                                        )}
                                                        {plan.durations?.custom?.enabled && (
                                                            <div className="flex justify-between items-center p-3 bg-slate-50 rounded-xl">
                                                                <span className="text-sm font-semibold">
                                                                    {plan.durations.custom.days} {language === 'ar' ? 'يوم' : 'days'}
                                                                </span>
                                                                <span className="text-lg font-black text-blue-600">
                                                                    {plan.durations.custom.price} {language === 'ar' ? 'ج.م' : 'EGP'}
                                                                </span>
                                                            </div>
                                                        )}
                                                    </div>

                                                    {/* Subscribe Button */}
                                                    <Button
                                                        onClick={() => navigate('/doctor/subscription-plans')}
                                                        className="w-full h-12 rounded-xl font-bold shadow-lg transition-all hover:scale-105"
                                                        style={{ backgroundColor: plan.color || '#3b82f6' }}
                                                    >
                                                        {language === 'ar' ? 'اشترك الآن' : 'Subscribe Now'}
                                                    </Button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {section === 'settings' && (
                        <div className="max-w-4xl animate-in fade-in duration-500">
                            <div className="bg-white rounded-3xl border border-slate-100 shadow-soft overflow-hidden">
                                <div className="p-10 border-b border-slate-50 overflow-hidden relative">
                                    <div className="flex flex-col sm:flex-row items-center gap-8 relative z-10">
                                        <div className="relative group cursor-pointer">
                                            <div className="w-32 h-32 rounded-[40px] bg-blue-100 flex items-center justify-center text-4xl font-black text-blue-700 border-4 border-white shadow-xl overflow-hidden group-hover:scale-105 transition-transform duration-300">
                                                {doctorData?.photoURL ? (
                                                    <img src={doctorData.photoURL} alt="Profile" className="w-full h-full object-cover" />
                                                ) : doctorData?.displayName?.charAt(0)}
                                            </div>
                                            <div className="absolute inset-0 bg-black/40 rounded-[40px] flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                <LogOut className="text-white rotate-[-90deg]" size={24} />
                                            </div>
                                        </div>
                                        <div className="text-center sm:text-left">
                                            <h3 className="text-2xl font-black text-slate-900 mb-1">{language === 'ar' ? doctorData?.nameAr : doctorData?.displayName}</h3>
                                            <p className="text-slate-500 font-medium mb-4">{doctorData?.email}</p>
                                            <div className="flex flex-wrap gap-2 justify-center sm:justify-start">
                                                <span className="px-3 py-1 bg-blue-50 text-blue-600 rounded-xl text-xs font-black uppercase tracking-tighter">
                                                    {doctorData?.specialization}
                                                </span>
                                                <span className="px-3 py-1 bg-amber-50 text-amber-600 rounded-xl text-xs font-black uppercase tracking-tighter">
                                                    {doctorData?.rating} ⭐
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    {/* Decoration */}
                                    <div className="absolute top-[-50px] end-[-50px] w-64 h-64 bg-blue-50/50 rounded-full blur-3xl -z-0" />
                                </div>

                                <form onSubmit={handleUpdateProfile} className="p-10 space-y-8">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-8">
                                        <div className="space-y-2">
                                            <Label className="text-xs font-black text-slate-500 uppercase tracking-widest ps-1">{t('doctorDash.profile.name')} (EN)</Label>
                                            <Input
                                                className="h-14 rounded-2xl bg-slate-50 border-transparent focus:bg-white focus:border-blue-500 transition-all font-bold text-slate-900"
                                                value={profileForm.displayName}
                                                onChange={e => setProfileForm({ ...profileForm, displayName: e.target.value })}
                                            />
                                        </div>
                                        <div className="space-y-2">
                                            <Label className="text-xs font-black text-slate-500 uppercase tracking-widest ps-1">{t('doctorDash.profile.name')} (AR)</Label>
                                            <Input
                                                className="h-14 rounded-2xl bg-slate-50 border-transparent focus:bg-white focus:border-blue-500 transition-all font-bold text-slate-900"
                                                value={profileForm.nameAr}
                                                onChange={e => setProfileForm({ ...profileForm, nameAr: e.target.value })}
                                            />
                                        </div>
                                        <div className="space-y-2">
                                            <Label className="text-xs font-black text-slate-500 uppercase tracking-widest ps-1">{t('doctorDash.profile.phone')}</Label>
                                            <Input
                                                className="h-14 rounded-2xl bg-slate-50 border-transparent focus:bg-white focus:border-blue-500 transition-all font-bold text-slate-900"
                                                value={profileForm.phone}
                                                onChange={e => setProfileForm({ ...profileForm, phone: e.target.value })}
                                            />
                                        </div>
                                        <div className="space-y-2">
                                            <Label className="text-xs font-black text-slate-500 uppercase tracking-widest ps-1">{t('doctorDash.profile.price')}</Label>
                                            <Input
                                                type="number"
                                                className="h-14 rounded-2xl bg-slate-50 border-transparent focus:bg-white focus:border-blue-500 transition-all font-bold text-slate-900"
                                                value={profileForm.consultationPrice}
                                                onChange={e => setProfileForm({ ...profileForm, consultationPrice: Number(e.target.value) })}
                                            />
                                        </div>
                                        <div className="space-y-2">
                                            <Label className="text-xs font-black text-slate-500 uppercase tracking-widest ps-1">{t('doctorDash.profile.specialization')}</Label>
                                            <select
                                                className="w-full h-14 rounded-2xl bg-slate-50 border-transparent focus:bg-white focus:border-blue-500 transition-all font-bold text-slate-900 px-4 outline-none"
                                                value={profileForm.specialization}
                                                onChange={e => setProfileForm({ ...profileForm, specialization: e.target.value })}
                                            >
                                                <option value="">Select Specialization</option>
                                                {specializations.map(s => <option key={s} value={s}>{s}</option>)}
                                            </select>
                                        </div>
                                        <div className="space-y-2">
                                            <Label className="text-xs font-black text-slate-500 uppercase tracking-widest ps-1">Governorate</Label>
                                            <select
                                                className="w-full h-14 rounded-2xl bg-slate-50 border-transparent focus:bg-white focus:border-blue-500 transition-all font-bold text-slate-900 px-4 outline-none"
                                                value={profileForm.governorate}
                                                onChange={e => setProfileForm({ ...profileForm, governorate: e.target.value })}
                                            >
                                                <option value="">Select Governorate</option>
                                                {governorates.map(g => <option key={g} value={g}>{g}</option>)}
                                            </select>
                                        </div>
                                        <div className="sm:col-span-2 flex items-center justify-between p-6 bg-slate-50 rounded-2xl border border-slate-100">
                                            <div>
                                                <h4 className="font-bold text-slate-900">Show Profile in Search</h4>
                                                <p className="text-xs text-slate-500 font-medium">Toggle your visibility on the public platform</p>
                                            </div>
                                            <button
                                                type="button"
                                                onClick={() => setProfileForm({ ...profileForm, showInSearch: !profileForm.showInSearch })}
                                                className={`w-14 h-8 rounded-full transition-all relative ${profileForm.showInSearch ? 'bg-blue-600' : 'bg-slate-300'}`}
                                            >
                                                <div className={`absolute top-1 w-6 h-6 bg-white rounded-full transition-all ${profileForm.showInSearch ? 'right-1' : 'left-1'}`} />
                                            </button>
                                        </div>
                                        <div className="sm:col-span-2 space-y-2">
                                            <Label className="text-xs font-black text-slate-500 uppercase tracking-widest ps-1">{t('doctorDash.profile.address')}</Label>
                                            <Input
                                                className="h-14 rounded-2xl bg-slate-50 border-transparent focus:bg-white focus:border-blue-500 transition-all font-bold text-slate-900"
                                                value={profileForm.clinicAddress}
                                                onChange={e => setProfileForm({ ...profileForm, clinicAddress: e.target.value })}
                                            />
                                        </div>
                                        <div className="sm:col-span-2 space-y-2">
                                            <Label className="text-xs font-black text-slate-500 uppercase tracking-widest ps-1">{t('doctorDash.profile.bio')}</Label>
                                            <Textarea
                                                className="min-h-[120px] rounded-2xl bg-slate-50 border-transparent focus:bg-white focus:border-blue-500 transition-all font-medium text-slate-700 leading-relaxed"
                                                value={profileForm.bio}
                                                onChange={e => setProfileForm({ ...profileForm, bio: e.target.value })}
                                            />
                                        </div>
                                    </div>

                                    <div className="flex flex-col sm:flex-row justify-between items-center gap-6 pt-10 border-t border-slate-50">
                                        <button
                                            type="button"
                                            onClick={() => setIsPasswordModalOpen(true)}
                                            className="text-slate-400 font-bold hover:text-rose-500 transition-colors flex items-center gap-2"
                                        >
                                            <Shield size={18} /> {t('doctorDash.profile.changePassword')}
                                        </button>
                                        <Button
                                            type="submit"
                                            className="w-full sm:w-auto h-14 px-12 rounded-2xl bg-blue-600 hover:bg-blue-700 text-white font-black shadow-xl shadow-blue-100 active:scale-95 transition-all"
                                        >
                                            {t('common.save')}
                                        </Button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            </main>

            {isPasswordModalOpen && (
                <ChangePasswordModal
                    onClose={() => setIsPasswordModalOpen(false)}
                />
            )}
        </div>
    );
};

const StatCard = ({ label, value, icon: Icon, color, bg }: any) => (
    <div className="bg-white p-8 rounded-[32px] border border-slate-100 shadow-soft hover:shadow-md transition-shadow group">
        <div className={`w-14 h-14 rounded-2xl ${bg} flex items-center justify-center ${color} mb-6 group-hover:scale-110 transition-transform duration-300`}>
            <Icon size={28} />
        </div>
        <p className="text-[11px] text-slate-400 font-bold uppercase tracking-widest mb-1">{label}</p>
        <h3 className="text-3xl font-black text-slate-900">{value}</h3>
    </div>
);

const StatusBadge = ({ status }: { status: string }) => {
    const styles: any = {
        pending: 'bg-amber-50 text-amber-600 border-amber-100',
        approved: 'bg-blue-50 text-blue-600 border-blue-100',
        completed: 'bg-emerald-50 text-emerald-600 border-emerald-100',
        cancelled: 'bg-rose-50 text-rose-600 border-rose-100'
    };

    return (
        <span className={`px-3 py-1.5 rounded-xl border text-[11px] font-black uppercase tracking-widest ${styles[status] || styles.pending}`}>
            {status}
        </span>
    );
};

export default DoctorDashboard;
